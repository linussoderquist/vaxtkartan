<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>TaxonKey Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <h1>Generera TaxonKeys från CSV</h1>
  <input type="file" id="fileInput" accept=".csv" />
  <button onclick="generateTaxonKeys()">Ladda ner CSV med TaxonKeys</button>
  <div id="status"></div>

  <script>
    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fetchTaxonKey(name, index) {
      try {
        const response = await fetch(`https://api.gbif.org/v1/species/match?name=${encodeURIComponent(name)}`);
        const data = await response.json();
        if (data.usageKey) {
          console.log(`✅ ${index}: ${name} → ${data.usageKey}`);
          return data.usageKey;
        } else {
          console.warn(`⚠️ ${index}: Ingen taxonKey för ${name}`);
          return "";
        }
      } catch (err) {
        console.error(`❌ ${index}: Fel vid hämtning för ${name}`, err);
        return "";
      }
    }

    async function generateTaxonKeys() {
      const fileInput = document.getElementById("fileInput");
      const status = document.getElementById("status");

      if (!fileInput.files.length) {
        alert("Välj en CSV-fil först.");
        return;
      }

      status.textContent = "Läser fil...";

      Papa.parse(fileInput.files[0], {
        header: true,
        complete: async function(results) {
          const data = results.data;
          const updatedData = [];
          let success = 0;
          let fail = 0;

          status.textContent = `Hämtar taxonKeys...`;

          for (let i = 0; i < data.length; i++) {
            const row = data[i];
            const name = row["Scientific name"]?.trim();
            if (!name) continue;

            const taxonKey = await fetchTaxonKey(name, i + 1);
            row["taxonKey"] = taxonKey;
            if (taxonKey) success++;
            else fail++;

            updatedData.push(row);
            if (i % 10 === 0) status.textContent = `Bearbetat ${i + 1}/${data.length} rader...`;

            await delay(150); // throttling
          }

          status.textContent = `Klart: ${success} lyckades, ${fail} misslyckades. Skapar fil...`;

          const csv = Papa.unparse(updatedData);
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "taxonkeys_resultat.csv";
          a.click();

          status.textContent += " – Fil nedladdad.";
        },
        error: function(err) {
          console.error("Fel vid CSV-läsning", err);
          status.textContent = "Fel vid filinläsning.";
        }
      });
    }
  </script>
</body>
</html>
